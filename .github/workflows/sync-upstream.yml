name: Sync from Upstream

on:
  schedule:
    # Sync every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual triggering
  repository_dispatch:
    types: [sync-request]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Git
        run: |
          git config --global user.name 'Auto Sync Bot'
          git config --global user.email 'sync@bot.local'
          git remote add upstream https://github.com/moltbot/moltbot.git
          
      - name: Sync with upstream
        run: |
          echo "Syncing with upstream..."
          git fetch upstream
          git checkout main
          git rebase upstream/main
          
          # Push changes back to origin
          if [ "$(git status --porcelain)" != "" ]; then
            echo "Changes detected, pushing to origin..."
            git push origin main
          else
            echo "No changes to push"
          fi
          
      - name: Check for conflicts
        run: |
          if [ $? -ne 0 ]; then
            echo "⚠️ Sync completed with conflicts - manual resolution may be needed"
            exit 1
          else
            echo "✅ Sync completed successfully"
          fi