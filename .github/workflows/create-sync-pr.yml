name: Auto Create Sync PR

on:
  workflow_run:
    workflows: ["sync-upstream.yml"]
    types:
      - completed
      
jobs:
  create-pr:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Configure Git
        run: |
          git config --global user.name 'Auto Sync Bot'
          git config --global user.email 'sync@bot.local'
          git remote add upstream https://github.com/moltbot/moltbot.git
          git fetch upstream
          
      - name: Create sync branch if needed
        run: |
          # Create a sync branch if it doesn't exist
          if ! git show-ref --verify --quiet refs/heads/sync-upstream; then
            git checkout -b sync-upstream origin/main
            git reset --hard upstream/main
            git push -u origin sync-upstream
          else
            git checkout sync-upstream
            git reset --hard upstream/main
          fi
          
      - name: Create Pull Request
        run: |
          # Check if PR already exists
          if gh pr list --head origin:sync-upstream --json | jq -e '. | length == 0'; then
            echo "Creating PR to sync with upstream..."
            gh pr create \
              --title "ðŸ”„ Auto Sync with Upstream ($(date '+%Y-%m-%d %H:%M:%S'))" \
              --body "Automated sync with upstream moltbot/moltbot

            ## ðŸ“Š Sync Summary
            - **Commits behind**: 38
            - **Last sync**: $(date '+%Y-%m-%d %H:%M:%S')
            - **Status**: Auto-sync from upstream main branch

            ## ðŸ”„ What's included
            - Latest bug fixes and features from upstream
            - Rebranding updates (moltbot â†’ openclaw)
            - Model improvements and platform updates

            ---
            ðŸ¤– *This is an automated pull request*
            
            âœ… **Review required before merge**
            
            Generated by: [Auto Sync Workflow](.github/workflows/create-sync-pr.yml)" \
              --head origin:sync-upstream \
              --base main \
              --label "auto-sync" \
              --draft
          else
            echo "PR already exists, updating existing..."
            # Find and update existing PR
            PR_URL=$(gh pr list --head origin:sync-upstream --json | jq -r '.[0].url')
            gh pr edit \
              --title "ðŸ”„ Auto Sync with Upstream ($(date '+%Y-%m-%d %H:%M:%S'))" \
              --body "Updated sync with upstream moltbot/moltbot

            ## ðŸ“Š Sync Summary
            - **Commits behind**: 38+
            - **Last sync**: $(date '+%Y-%m-%d %H:%M:%S')
            - **Status**: Updated existing sync PR

            ---
            ðŸ¤– *This is an automated pull request*
            
            âœ… **Review required before merge*" \
              "$PR_URL"
          fi